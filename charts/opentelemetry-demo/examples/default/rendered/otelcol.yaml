---
# Source: opentelemetry-demo/templates/otelcol.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: example-otelcol-config
  labels:
    helm.sh/chart: opentelemetry-demo-0.2.1
    app.kubernetes.io/name: example
    app.kubernetes.io/instance: example
    app.kubernetes.io/component: otelcol
    app.kubernetes.io/version: "0.3.4-alpha"
    app.kubernetes.io/managed-by: Helm
data:
  otelcol-config.yml: |
    receivers:
      otlp:
        protocols:
          grpc:
          http:
    exporters:
      jaeger:
        endpoint: "${JAEGER_ADDR}"
        tls:
          insecure: true
      logging:
    
    processors:
      batch:
    
    service:
      pipelines:
        traces:
          receivers:
            - otlp
          processors:
            - batch
          exporters:
            - logging
            - jaeger
---
# Source: opentelemetry-demo/templates/otelcol.yaml
apiVersion: v1
kind: Service
metadata:
  name: example-otelcol
  labels:
    helm.sh/chart: opentelemetry-demo-0.2.1
    app.kubernetes.io/name: example
    app.kubernetes.io/instance: example
    app.kubernetes.io/component: otelcol
    app.kubernetes.io/version: "0.3.4-alpha"
    app.kubernetes.io/managed-by: Helm
spec:
  ports:
    - name: otlp
      port: 4317
      protocol: TCP
      targetPort: 4317
    - name: otlphttp
      port: 4318
      protocol: TCP
      targetPort: 4318
    - name: metric 
      port: 8888
      protocol: TCP
      targetPort: 8888
  selector:
    app.kubernetes.io/name: example
    app.kubernetes.io/instance: example
    app.kubernetes.io/component: otelcol
---
# Source: opentelemetry-demo/templates/otelcol.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-otelcol
  labels:
    helm.sh/chart: opentelemetry-demo-0.2.1
    app.kubernetes.io/name: example
    app.kubernetes.io/instance: example
    app.kubernetes.io/component: otelcol
    app.kubernetes.io/version: "0.3.4-alpha"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: example
      app.kubernetes.io/instance: example
      app.kubernetes.io/component: otelcol
  template:
    metadata:
      labels:
        checksum/otel_config: 4730a8fedeb3189a4835e3ea5c65ff15d2051838261f9da7deca79a7c3048b6
        app.kubernetes.io/name: example
        app.kubernetes.io/instance: example
        app.kubernetes.io/component: otelcol
    spec:
      containers:
      - image: otel/opentelemetry-collector:0.55.0
        name: otel-col
        args: ["--config=/etc/otelcol-config.yml"]
        env:
          - name: JAEGER_ADDR
            value: example-jaeger:14250
        ports:
          - containerPort: 4317
            protocol: TCP
          - containerPort: 4318
            protocol: TCP
          - containerPort: 8888
            protocol: TCP
        volumeMounts:
          - mountPath: /etc/otelcol-config.yml
            name: otel-config 
            subPath: otelcol-config.yml
      volumes:
        - configMap:
            name: example-otelcol-config
          name: otel-config
